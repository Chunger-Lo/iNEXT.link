---
output:
  word_document: default
  html_document: default
---


## Import 

```{r, include = FALSE, warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE, message = FALSE,
  echo = F,
  comment = ""
)
#devtools::load_all(".")
library(ggplot2)
library(ggpubr)
# library(kableExtra)
library(knitr)
library(flextable)
library(tibble)
library(iNEXT.3D)
library(tidyr)
library(ade4)
library(tidyverse)
library(ape)
library(dplyr)
library(phytools)
library(magrittr)
library(chaoUtility)
library(future.apply)
library(abind)
```

```{r}
library(iNEXT.beta)
source('..//R//iNEXTlink.R')
source('..//R//myfunc.R')
source('..//R//subfunction.R')
```

```{r}
# load(file = "data//beetles_tree.rda")
load(file = "..//data//Norfolk.rda")
load(file = "..//data//puerto.rico.rda")

taxonomic_data = Norfolk
phylog_data = puerto.rico

```


### Datainfo


```{r}
datainf1 = DataInfo.link(data = taxonomic_data, 
                        diversity = 'TD', datatype = "abundance")

datainf1%>%
  flextable()
```


## Taxonomic:
### Calculation

```{r, message = F, warning=F}
bef = Sys.time()
b = 5
sample1 <- iNEXT.link(data = taxonomic_data, diversity = 'TD', datatype = "abundance", nboot = b)
asy1 = Asy.link(taxonomic_data, diversity = 'TD', q = seq(0,2,0.25),nboot = b)
obs1 = Obs.link(taxonomic_data, diversity = 'TD', q = seq(0,2,0.25),nboot = b)
sc1 <- SC.link(data = taxonomic_data, datatype = "abundance", nboot = b)
spec1 = Spec.link(taxonomic_data, q = seq(0,2,1), datatype = "abundance", nboot = b)
# # Beta
dissimilarity1 = iNEXTbeta.link(data = taxonomic_data, level = seq(0.5,0.95,0.05),
                                    datatype='abundance',q = c(0, 1, 2),diversity='TD',
                                    nboot = b, conf = 0.95)

aft = Sys.time()
print(aft-bef)
save(sample1, asy1, obs1, sc1, spec1, dissimilarity1,
     file = "output//Norfolk//taxonomic.RData")
# save(sample1, asy1, obs1, sc1, spec1, dissimilarity_pool, dissimilarity_byplot,dissimilarity_bytreat,
#      file = "output//remove1//taxonomic_remove_dominance.RData")

# load("output//nofilter//taxonomic.RData")
load("output//taxonomic_remove1//taxonomic.RData")
```



### 1.Sample completeness

```{r, fig.height=3, fig.width=5}
ggSC.link(sc1)
```

### 2.Asymptotic/ Empirical diversity

```{r fig.height=3, fig.width=5}
ggAsy.link(rbind(obs1, asy1))
```

```{r}
rbind(obs1, asy1)%>%
  filter(Order.q %in% c(0,1,2))%>%
  ggplot(aes(x=Method,y = qD, fill = Network, color = Network, 
             ymin = qD.LCL, ymax = qD.UCL, group = 1))+
  geom_point()+
  geom_errorbar(width = 0.2, size = 1)+
  # facet_grid(Order.q~Method, scale = "free")+
  facet_grid(Order.q~., scale = "free")+
  theme_bw()+ylab('qD')
```

### 3.Rarefaction / Extrapolation

```{r, fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT.link(sample1, diversity = 'TD', type = 1,facet.var = "Order.q" )
ggiNEXT.link(sample1, diversity = 'TD', type = 3,facet.var = "Order.q" )
```


### Closer look at q = 0

```{r, fig.width=9, fig.height=3, fig.align="center",warning=FALSE}
re_size = sample1$iNextEst$size_based
re_coverage = sample1$iNextEst$coverage_based
size_view = re_size%>%
  filter(Order.q == 0)%>%
  filter(m < 10000)%>%
  ggplot(aes(x = m, y = qD, fill = Assemblage))+
  geom_point(aes(color = Assemblage))+geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL), alpha=0.3)+
  geom_line(aes(color = Assemblage))+theme_bw()
coverage_view = re_coverage%>%
  filter(Order.q == 0)%>%
  filter(qD < 160)%>%
  # filter(goalSC > 0.5, goalSC < 0.95)。%>%
  ggplot(aes(x = goalSC, y = qD, fill = Assemblage))+
  geom_point(aes(color = Assemblage))+geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL), alpha=0.3)+
  geom_line(aes(color = Assemblage))+theme_bw()

ggarrange(size_view,coverage_view, nrow=1 )
```



### 4.Specialization


```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
# ggSpec.link(spec1%>%lapply(function(x){x%>%rename('method'='Method')}))
ggSpec.link(spec1)
```

### 5.Dissimilarity

#### Compare treatment G and O with pooled abundance

```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXTbeta.link(outcome = dissimilarity1, type = 'B')
```


## Phylogenetic: 

### Calculation

```{r, message = F, warning=F}
b = 5
data = phylog_data$data;diversity = 'PD';datatype = "abundance";
conf=0.95;q = c(0,1,2);size = NULL;ndpoint = NULL;knots = 40
nboot = b;col.tree = phylog_data$col.tree;row.tree = phylog_data$row.tree;PDtype='PD'

sample2 <- iNEXT.link(data = phylog_data$data, diversity = 'PD', datatype = "abundance",
                      nboot = b,col.tree = phylog_data$col.tree, row.tree = phylog_data$row.tree)


asy2 = Asy.link(phylog_data$data, diversity = 'PD', q = seq(0,2,0.25),nboot = b,
                col.tree = phylog_data$col.tree, row.tree = phylog_data$row.tree)
obs2 = Obs.link(phylog_data$data, diversity = 'PD', q = seq(0,2,0.25),nboot = b,
                col.tree = phylog_data$col.tree, row.tree = phylog_data$row.tree)


  
phy_dissimilarity = iNEXTbeta.link(data = phylog_data$data,
                                     level = seq(0.5,0.95,0.05),
                                     datatype='abundance',q = c(0, 1, 2),diversity='PD',
                                     nboot = b, conf = 0.95,
                                     col.tree = phylog_data$col.tree, row.tree = phylog_data$row.tree)


save(sample2, asy2, obs2,
     phy_dissimilarity,
     file = "output//puerto.rico//phylogenetic.RData")
aft = Sys.time()
print(aft - bef)
load("output//puerto.rico//phylogenetic.RData")
```


### 1.Asymptotic/ Empirical diversity

```{r}
ggAsy.link(rbind(obs2, asy2))
```
```{r}
rbind(obs2, asy2)%>%
  filter(Order.q %in% c(0,1,2))%>%
  ggplot(aes(x=Method,y = qD, fill = Network, color = Network, 
             ymin = qD.LCL, ymax = qD.UCL, group = 1))+
  geom_point()+
  geom_errorbar(width = 0.2, size = 1)+
  # facet_grid(Order.q~Method, scale = "free")+
  facet_grid(Order.q~., scale = "free")+
  theme_bw()+ylab('qPD')
```


### 2.Rarefaction / Extrapolation

```{r, fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT.link(sample2, diversity = 'PD', type = 1,facet.var = "Order.q" )
ggiNEXT.link(sample2, diversity = 'PD', type = 3,facet.var = "Order.q" )
```

### Closer look at q = 0

```{r, fig.width=9, fig.height=3, fig.align="center",warning=FALSE}
re_size = sample2$iNextEst

size_view = re_size%>%
  filter(Order.q == 0)%>%
  filter(m < 10000)%>%
  ggplot(aes(x = m, y = PD, fill = Region))+
  geom_point(aes(color = Region))+geom_ribbon(aes(ymin = PD.LCL, ymax = PD.UCL), alpha=0.3)+
  geom_line(aes(color = Region))+theme_bw()
coverage_view = re_size%>%
  filter(Order.q == 0)%>%
  filter(PD < 300)%>%
  # filter(goalSC > 0.5, goalSC < 0.95)。%>%
  ggplot(aes(x = SC, y = PD, fill = Region, color = Region))+
  geom_point(aes(color = Region))+geom_ribbon(aes(ymin = PD.LCL, ymax = PD.UCL), alpha=0.3)+
  geom_line(aes(color = Region))+theme_bw()

ggarrange(size_view,coverage_view, nrow=1 )
```


### 3.Dissimilarity

#### Compare treatment G and O with pooled abundance
```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXTbeta.link(phy_dissimilarity, diversity = 'PD', type = 'B')
```


#### Plot-wise comparison
```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXTbeta.link(phy_dissimilarity_byplot, diversity = 'PD', type = 'B')
```

### Take a closer look (indivisually scaling)
```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXTbeta.link(phy_dissimilarity_byplot, diversity = 'PD', type = 'B')+
  facet_wrap(div_type~Order, scale = 'free') +
  theme(legend.position = "bottom", legend.title = element_blank(),
        strip.text.x = element_blank())
```


#### Treatment-wise comparison

```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXTbeta.link(phy_dissimilarity_by_treat, diversity = 'PD', type = 'B')
```


### Take a closer look (indivisually scaling)
```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXTbeta.link(phy_dissimilarity_by_treat, diversity = 'PD', type = 'B')+
  facet_wrap(div_type~Order, scale = 'free') +
  theme(legend.position = "bottom", legend.title = element_blank(),
        strip.text.x = element_blank())
```
