---
output:
  word_document: default
  html_document: default
---


## Import 

```{r, include = FALSE, warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE, message = FALSE,
  echo = F,
  comment = ""
)
#devtools::load_all(".")
library(ggplot2)
library(ggpubr)
# library(kableExtra)
library(knitr)
library(flextable)
library(tibble)
library(iNEXT.3D)
# library(sets)
library(tidyr)
library(ade4)
library(tidyverse)
library(ape)
library(dplyr)
library(phytools)
library(magrittr)
library(chaoUtility)
library(future.apply)
```

```{r}
# library(miNEXT.beta)
source('..//R//iNEXTlink.R')
source('..//R//myfunc.R')
source('..//R//subfunction.R')
```

```{r}
# load(file = "data//beetles_tree.rda")
load(file = "..//data//beetles_plot_treat.rda")
load(file = "..//data//beetles_treat_plot.rda")
network_list = beetles_plot_treat$data
coltree = beetles_plot_treat$col.tree
rowtree = NULL

network_list_byplots = list(A_G = network_list[['A']][['G']],
                            A_O = network_list[['A']][['O']],
                            B_G = network_list[['B']][['G']],
                            B_O = network_list[['B']][['O']],
                            C_G = network_list[['C']][['G']],
                            C_O = network_list[['C']][['O']])

load(file = "..//data//beetles_pool.rda")
network_list = beetles_pool$data

```


### Datainfo


```{r}
datainf1 = DataInfo.link(data = network_list_byplots, 
                        diversity = 'TD', datatype = "abundance")
datainf1%>%separate(col = 'Assemblages', into = c('Plot', 'Treatment'))%>%
  flextable()
```

---

```{r}
datainf_pool = DataInfo.link(data = network_list, 
                        diversity = 'TD', datatype = "abundance")
datainf_pool%>%
  flextable()
```

<!-- ### Visualization -->

<!-- ```{r} -->
<!-- bipartite::visweb(network_list[[1]]%>%as.matrix()) -->
<!-- bipartite::visweb(network_list[[2]]%>%as.matrix()) -->
<!-- ``` -->

## Taxonomic:
### Calculation

```{r, message = F, warning=F}
bef = Sys.time()
b = 10
sample1 <- iNEXT.link(data = network_list, diversity = 'TD', datatype = "abundance", nboot = b)
asy1 = Asy.link(network_list, diversity = 'TD', q = seq(0,2,0.25),nboot = b)
obs1 = Obs.link(network_list, diversity = 'TD', q = seq(0,2,0.25),nboot = b)
sc1 <- SC.link(x = network_list, datatype = "abundance", nboot = b)
spec1 = Spec.link(network_list, q = seq(0,2,1), datatype = "abundance", nboot = b)
# Beta
dissimilarity_pool = iNEXTbeta.link(x = beetles_pool$data, level = seq(0.5,0.95,0.05),
                                    datatype='abundance',q = c(0, 1, 2), diversity='TD',
                                    nboot = b, conf = 0.95, max_alpha_coverage=F)

dissimilarity_byplot = iNEXTbeta.link(x = beetles_plot_treat$data, level = seq(0.5,0.95,0.05),datatype='abundance',q = c(0, 1, 2),diversity='TD',
                                 nboot = b, conf = 0.95, max_alpha_coverage=F)

dissimilarity_bytreat = iNEXTbeta.link(x = beetles_treat_plot$data, level = seq(0.5,0.95,0.05),datatype='abundance',q = c(0, 1, 2),diversity='TD',
                                 nboot = b, conf = 0.95, max_alpha_coverage=F)

# save(sample1, asy1, obs1, sc1, spec1, dissimilarity_pool, dissimilarity_byplot,dissimilarity_bytreat,
#      file = "output//taxonomic.RData")
# load("output//taxonomic.RData")
```



### 1.Sample completeness

```{r, fig.height=3, fig.width=5}
ggSC.link(sc1)
```

### 2.Asymptotic/ Empirical diversity

```{r fig.height=3, fig.width=5}
ggAsy.link(rbind(obs1, asy1))
```

```{r}
rbind(obs1, asy1)%>%
  filter(Order.q %in% c(0,1,2))%>%
  ggplot(aes(x=Method,y = qD, fill = Network, color = Network, 
             ymin = qD.LCL, ymax = qD.UCL, group = 1))+
  geom_point()+
  geom_errorbar(width = 0.2, size = 1)+
  # facet_grid(Order.q~Method, scale = "free")+
  facet_grid(Order.q~., scale = "free")+
  theme_bw()+ylab('qD')
```


```{r}
asy1%>%filter(Order.q%in%c(0,1,2))%>%arrange(Method, Order.q)%>%flextable()
```

### 3.Rarefaction / Extrapolation

```{r, fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT.link(sample1, diversity = 'TD', type = 1,facet.var = "Order.q" )
ggiNEXT.link(sample1, diversity = 'TD', type = 3,facet.var = "Order.q" )
```


### Closer look at q = 0

```{r, fig.width=9, fig.height=3, fig.align="center",warning=FALSE}
re_size = sample1$iNextEst$size_based
re_coverage = sample1$iNextEst$coverage_based
size_view = re_size%>%
  filter(Order.q == 0)%>%
  filter(m < 10000)%>%
  ggplot(aes(x = m, y = qD, fill = Assemblage))+
  geom_point(aes(color = Assemblage))+geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL), alpha=0.3)+
  geom_line(aes(color = Assemblage))+theme_bw()
coverage_view = re_coverage%>%
  filter(Order.q == 0)%>%
  filter(qD < 160)%>%
  # filter(goalSC > 0.5, goalSC < 0.95)。%>%
  ggplot(aes(x = goalSC, y = qD, fill = Assemblage))+
  geom_point(aes(color = Assemblage))+geom_ribbon(aes(ymin = qD.LCL, ymax = qD.UCL), alpha=0.3)+
  geom_line(aes(color = Assemblage))+theme_bw()

ggarrange(size_view,coverage_view, nrow=1 )
```



### 4.Specialization


```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggSpec.link(spec1)
```

### 5.Dissimilarity

考慮三種dissimilarity
a. 整個區域中, G和O間的相異程度
b. Plot-wise: 給定不同的Plot(A,B,C)下, treatment G和O間的相異程度
c. Treatment-wise: 給定不同的Treatment(G,0)下, plot A,B,C間的相異程度

#### Compare treatment G and O with pooled abundance

```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT_beta.link(dissimilarity_pool, type = 'B')
```

#### Plot-wise comparison
```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT_beta.link(dissimilarity_byplot, type = 'B')
```


### Take a closer look (indivisually scaling)
```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT_beta.link(dissimilarity_byplot, diversity = 'TD', type = 'B')+
  facet_wrap(div_type~Order, scale = 'free') +
  theme(legend.position = "bottom", legend.title = element_blank(),
        strip.text.x = element_blank())
```

#### Treatment-wise comparison

```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT_beta.link(dissimilarity_bytreat, type = 'B')
```

### Take a closer look (indivisually scaling)
```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT_beta.link(dissimilarity_bytreat, diversity = 'TD', type = 'B')+
  facet_wrap(div_type~Order, scale = 'free') +
  theme(legend.position = "bottom", legend.title = element_blank(),
        strip.text.x = element_blank())
```

## Phylogenetic: 

### Calculation

```{r, message = F, warning=F}
b =50
sample2 <- iNEXT.link(x = network_list, diversity = 'PD', datatype = "abundance",
                      nboot = b,col.tree = coltree, row.tree = rowtree)


asy2 = Asy.link(network_list, diversity = 'PD', q = seq(0,2,0.25),nboot = b,
                col.tree = coltree, row.tree = rowtree)
obs2 = Obs.link(network_list, diversity = 'PD', q = seq(0,2,0.25),nboot = b,
                col.tree = coltree, row.tree = rowtree)
phy_dissimilarity_pool = iNEXT_beta.link(x = beetles_pool$data,
                                     level = seq(0.5,0.95,0.05),
                                     datatype='abundance',q = c(0, 1, 2),diversity='PD',
                                     nboot = b, conf = 0.95, max_alpha_coverage=F,
                                     col.tree = coltree, row.tree = rowtree)
phy_dissimilarity_byplot = iNEXT_beta.link(x = beetles_plot_treat$data,
                                     level = seq(0.5,0.95,0.05),
                                     datatype='abundance',q = c(0, 1, 2),diversity='PD',
                                     nboot = b, conf = 0.95, max_alpha_coverage=F,
                                     col.tree = coltree, row.tree = rowtree)
phy_dissimilarity_by_treat = iNEXT_beta.link(x = beetles_treat_plot$data,
                                     level = seq(0.5,0.95,0.05),
                                     datatype='abundance',q = c(0, 1, 2),diversity='PD',
                                     nboot = b, conf = 0.95, max_alpha_coverage=F,
                                     col.tree = coltree, row.tree = rowtree)
# save(sample2, asy2, obs2,
#      phy_dissimilarity_pool, phy_dissimilarity_byplot,phy_dissimilarity_by_treat,
#      file = "output//phylogenetic.RData")

# aft = Sys.time()
# print(aft - bef)
load("output//phylogenetic.RData")
```


### 1.Asymptotic/ Empirical diversity

```{r}
ggAsy.link(rbind(obs2, asy2))
```
```{r}
rbind(obs2, asy2)%>%
  filter(Order.q %in% c(0,1,2))%>%
  ggplot(aes(x=Method,y = qD, fill = Network, color = Network, 
             ymin = qD.LCL, ymax = qD.UCL, group = 1))+
  geom_point()+
  geom_errorbar(width = 0.2, size = 1)+
  # facet_grid(Order.q~Method, scale = "free")+
  facet_grid(Order.q~., scale = "free")+
  theme_bw()+ylab('qPD')
```


```{r}
asy1%>%filter(Order.q%in%c(0,1,2))%>%arrange(Method, Order.q)%>%flextable()
```


### 2.Rarefaction / Extrapolation

```{r, fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT.link(sample2, diversity = 'PD', type = 1,facet.var = "Order.q" )
ggiNEXT.link(sample2, diversity = 'PD', type = 3,facet.var = "Order.q" )
```

### Closer look at q = 0

```{r, fig.width=9, fig.height=3, fig.align="center",warning=FALSE}
re_size = sample2$iNextEst

size_view = re_size%>%
  filter(Order.q == 0)%>%
  filter(m < 10000)%>%
  ggplot(aes(x = m, y = PD, fill = Region))+
  geom_point(aes(color = Region))+geom_ribbon(aes(ymin = PD.LCL, ymax = PD.UCL), alpha=0.3)+
  geom_line(aes(color = Region))+theme_bw()
coverage_view = re_size%>%
  filter(Order.q == 0)%>%
  filter(PD < 300)%>%
  # filter(goalSC > 0.5, goalSC < 0.95)。%>%
  ggplot(aes(x = SC, y = PD, fill = Region, color = Region))+
  geom_point(aes(color = Region))+geom_ribbon(aes(ymin = PD.LCL, ymax = PD.UCL), alpha=0.3)+
  geom_line(aes(color = Region))+theme_bw()

ggarrange(size_view,coverage_view, nrow=1 )
```


### 3.Dissimilarity

#### Compare treatment G and O with pooled abundance
```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT_beta.link(phy_dissimilarity_pool, diversity = 'PD', type = 'B')
```


#### Plot-wise comparison
```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT_beta.link(phy_dissimilarity_byplot, diversity = 'PD', type = 'B')
```

### Take a closer look (indivisually scaling)
```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT_beta.link(phy_dissimilarity_byplot, diversity = 'PD', type = 'B')+
  facet_wrap(div_type~Order, scale = 'free') +
  theme(legend.position = "bottom", legend.title = element_blank(),
        strip.text.x = element_blank())
```


#### Treatment-wise comparison

```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT_beta.link(phy_dissimilarity_by_treat, diversity = 'PD', type = 'B')
```


### Take a closer look (indivisually scaling)
```{r,fig.width=7, fig.height=4, fig.align="center",warning=FALSE}
ggiNEXT_beta.link(phy_dissimilarity_by_treat, diversity = 'PD', type = 'B')+
  facet_wrap(div_type~Order, scale = 'free') +
  theme(legend.position = "bottom", legend.title = element_blank(),
        strip.text.x = element_blank())
```
